<html>
<body>
  <head>

    <title>Bootstrap Example</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
  <!DOCTYPE html>
</head>  

<html>
  





<div id = "div1"> </div>
  <input type="hidden" id="val" name="val" value="1">
  <div id = "removeButton">
  <div id = "displayMessage"></div>
<center><input   id="button1" onclick = "restoreOriginalOrder()"  type="submit" value="Return to Original Order"/></center>
</div>







<script>  

window.sessionStorage

/////
function restoreOriginalOrder()
{
	
	//if(val1 = sessionStorage.getItem("numberOfRecordsChosen"))
	//{
	//	
	//	if (val1 == MAXRECORDS)
	//	{
	//		alert("AT RECORD MAXIMUM, YOU MUST REMOVE A RECORD TO RETURN TO PURCHASE!");
	//		return;
	//	}
	//}

	//alert("restoreOriginalOrder");
	window.location.href = "index.html?displayOrdersTemplateAgain=1";
	return(1);

}
/////

//newest, just created
function checkAllAvailableProducts(quantity, gtotal, grandTotalID){



let grandTotal1 = "";
let total = "";

var gtotal = parseFloat(gtotal);


//leading letter for ids that are used in cart template
var val1 = "";

var var1 = "A";

var var2 = "C";

var var3 = "D"; 

var var4 = "B";

var var5 = "V";

var var6 = "P";

var counter = -1;
var string = "";

var item = 0;
var AmountToBuyID = 0;
var AmountOfCostID = 0;
var AmountOfQuantityID = 0; 
var bought = 0;

  
  var flagToReturnOut = false;
  let keys = Object.keys(sessionStorage);
  
  var amtOfHiddenProducts = 0;

  //each iteration is one purchase
  for(let key of keys) {
	  counter++;
	  if(key =="sessionUserID")
	  {
		counter--;
	   
		continue;
	  }
	  
	  if(key =="keywords")
	  {
		counter--;
		
		continue;
	  }
	  if(key =="numberOfRecordsChosen")
	  {
		counter--;
	   
		continue;
	  }
	  //if(key =="alreadyZero")
	  //{
	  //  counter--;
	  // 
	  //  continue;
	  //}
	  if(key =="amtOfKeywords")
	  {
		counter--;
	   
		continue;
	  }

	 

	  
	  //if here, is productid and a quantity
	  AmountToBuyID = var1 + counter;
	  AmountOfCostID = var2 + counter;
	  AmountOfQuantityID = var3 + counter;
	  BoughtID = var4 + counter;
	  oneDivID = var5 + counter;
	  ProductIDID = var6 + counter;
	
	  var bought = (document.getElementById(BoughtID).value);
	  var amtInBuyBox =(document.getElementById(AmountToBuyID).value);
	  var quantityInBox = (document.getElementById(AmountOfQuantityID).value);
	  var costInBox = (document.getElementById(AmountOfCostID).value); 
	  var Product = (document.getElementById(ProductIDID).value); 
	 
	  var item = amtInBuyBox;
	 
	  
	 
	  //because amount to buy is nothing than change buying to nothing
	  if (item == "")
	  { 
		
		item = bought;
	  
	  }
	  //check if is decimal
	  if(item % 1 != 0)
	  {
		
		return(1);
		
	  }

	  if(item == 0)
	  {

			   
				hideRow(oneDivID);
				amtOfHiddenProducts++;
			   
		//continue;
		
	  }
	  
	  else if(item < 0 ) 
	  {
		
		//var str2 = amtInBuyBox.toString();
	   
		flagToReturnOut= true;
	  }
	  else if (isNaN(item ))
	  {
		
		//var str2 = amtInBuyBox.toString();
	   
		flagToReturnOut= true;
	  }

	  
	  if (flagToReturnOut == true)
	  {
		return;
	  }

	  //id and amount trying to buy
	  string =  string + "id=" + key + "&amtTryingToPurchase=" + item + "&";

	 
		
	  

  }//end


 

  
  //all products are hidden, so do this
  if (amtOfHiddenProducts == (counter + 1))
  {
	

	
	
	//reset sessio variables because goint baack to index
	
	
	var sessID1 = sessionStorage.getItem("sessionUserID");
	alert("a");
	alert(sessID1);
	sessionStorage.clear();
	sessionStorage.setItem("sessionUserID", sessID1);
	sessionStorage.setItem("numberOfRecordsChosen", "0");
	

	
	window.location.href = "index.html";
	return(1);
	
	
  
  }
  //build string
  string = string + "userid=1&";//sessionStorage.getItem("sessionUserID");

  //removed &
var queryString = string;//.substring(0, string.length-1);

let flagisEnoughProduct = true;


			$.ajax({
			url: 'http://localhost:8080/sendBackNewCartData',
			type: 'GET',
			dataType: 'json',
			
			
			data:queryString,
			crossDomain: true,
		   
			success: function (data) {
			  

			  

			  //no records
			  if(data.length == null){

			  
			  window.location.href = "index.html";
			  return(1);
			  //window.location.href = "index.html";
			   }

			  
			  for (var i = 0; i< data.length ;i++)
			  {
				
				
			  if(data[i].IsEnoughQuantity == false)
			  {
			

				

				flagisEnoughProduct = false;
				break;
			  //flag = "not enough";
			  
			 
			  }

			  }

			  


			  if (flagisEnoughProduct == true)
			  {
				
				window.location.href = "donePurchase.html";
				return(1);
			  }


			  //if here, there is at least one record that doesnt have enough product
			  

			var lengthOfData = data.length;

			
			
			console.log(data);


			  
			 
			  for(var i = 0; i<(lengthOfData) ; i++)
			  {

			   //for ids of carttemplate's ids
			  var boughtid = "B" + i; 
			  var buyThisManyID = "A" + i;
			  var availableID =  "D" + i;
			  var costID = "C" + i;
			  var totalCostID = "TC" + i;
			  var GrandTotalStringID = "GT" + i;
			  var mainDivID =  "V" + i;
			  
		   
			  var isEnoughQuantity = false;
			  //still in loop
			  isEnoughQuantity = data[i].IsEnoughQuantity;
			  
			 
			 
			  //wasnt enough, so make red


			  if (isEnoughQuantity == false)
			  {  
				//debugger;
				
				//RED
				//change settings of cart template if the current record doesn't have enough product in db for request 
				var avail = (document.getElementById(availableID).value);
				document.getElementById(buyThisManyID).value = 0;
				let boughtValue = (document.getElementById(boughtid).value);
				
				
				
				document.getElementById(availableID).style.color = 'red';
				
				//amount to buy
				document.getElementById(buyThisManyID).value = 0;
				//buying
				document.getElementById(boughtid).value = 0;
				//total cost for productID
				document.getElementById(totalCostID).value = "$0.00";
				
				document.getElementById(availableID).value = (parseInt(avail) + parseInt(boughtValue) );

				//is enough quantity
			  }else{
			  
				document.getElementById(availableID).style.color = 'black';
				///////
				
				//amount to buy
				let amountToBuy1 = document.getElementById(buyThisManyID).value; //3
			   
				costID = "C" + i;
			  var totalCostID = "TC" + i;

				//
			  var a = 1/6
			  //////////
			  let parsedAmountToBuy1 = parseInt(amountToBuy1);

			  document.getElementById(boughtid).value =  Number(parsedAmountToBuy1);
			  document.getElementById(availableID).value = Number(document.getElementById(availableID).value) -  Number(parsedAmountToBuy1);  
			  SetTotalCostAndSumGrandTotal(costID, boughtid, totalCostID);


			  }

			}

			if (TotaledAtLeastOnceFLag == true)
			{
			  setGrandTotal(GrandTotalStringID);
			  TotaledAtLeastOnceFLag  = false;
			}

		   

		  
		}

		});
}//function

////

function checkForPassword()
{
	var isThereACorrectPassword = sessionStorage.getItem("sessionUserID");
	
	//is no password
	if (!isThereACorrectPassword)
	{
		window.location.href = "login.html";
	}
	
}

////

//this is in callTemplateTwo.html and index.html
var MAXRECORDS = 20



/////////

function checkForPassword()
{
	
	var isThereACorrectPassword = sessionStorage.getItem("sessionUserID");
	
	//is no password
	if (!isThereACorrectPassword)
	{
	
	window.location.href = "login.html";
	}
	else
	{
	document.getElementById("button1").style.visibility = "visible";
	

}
	
}


/////////

//loads ajax on page start
$(function(){

////////
document.getElementById("button1").style.visibility = "hidden";
	
	checkForPassword();

loadData();

////////
//  loadajax();
});


    //////////////////


//checkout button pressed, so is here!
//data is here by sessionstorage
//send it to purge which calls template with data

//restoring past order screen
var gFlagIsSomeRecords = false;
var queryString= ""; 

//calls template2, load ProductID/amount of quantity purchasing
function loadData() {
 

 var string = "";
//////////////////////

let keys = Object.keys(sessionStorage);
var var1 = "hasntBeenHere";

for(let key of keys) {


  
  
  if(key == "sessionUserID")
  {
    continue;
  }
  else if(key == "keywords")
  {
		continue;
  }
  else if(key == "numberOfRecordsChosen")
  {
		continue;
  }
  //else if(key == "alreadyZero")
  //{
//		continue;
//  }

  else if(key == "amtOfKeywords")
  {
		continue;
  }
 

  
  


  
  
  
  //check for not an integer

  var item = sessionStorage.getItem(key);



  
  alert("should be here!");
  string =  string + "id=" + key + "&amtTryingToPurchase=" + item + "&";
  
  
  gFlagIsSomeRecords = true;


  
    
    
  
}













// no ur//parameters from search at index.html - checkout pressed with nothing selected


//not any  ids and quants
//if(var1 == "hasntBeenHere")
//  {
	  //if checkout has no quant... than here DoesKeywordAlreadyExist checkout to removeKeyword
	  //if search pressed get checkout from session
	  //and remove keyword
	 

	  //var val1 = document.getElementById(dispalyMessage).value;
	  //document.getElementById("displayMessage").innerHTML = "No products were selected!";
	
//	  gFlagIsSomeRecords = true;
	  //var storedArray = [];
	  //sessionStorage.setItem("checkoutPressed", "pressed");
	 
	  //storedArray = JSON.parse(sessionStorage.getItem("keywords"))
	  //storedArray.push(val1);
	  //sessionStorage.removeItem


	
    
    //window.location.href = "index.html?displayOrdersTemplateAgain=1&";
    //return(1);
 // }

  
  
//overWrites"&
if(gFlagIsSomeRecords == true)
{
	queryString = string.substring(0, string.length-1);
	
	
}
//else
//{
	
	//queryString = "";
//}

///


var url = "http://localhost:8080/cartTemplate";
//var queryString = "user_name=jerry&password=666666&user_name=marry&password=11111";


////////




////////
					
  					var val1 = ""
                    $.ajax({
                    type:'POST',
					datatype: 'html',
                    url:url,
                    data:queryString,
                    async:false,
                    success: function (data1) {
						
						//debugger;
						
					  val1 = data1;
					  //if isnt some record
                      if (gFlagIsSomeRecords)
					  {
						  
						  //displays table
							alert("yes1");
							alert(data1);
							//displays on checkout nd then goes to login
							//debugger;
							document.getElementById('div1').innerHTML  = val1;
							//debugger;
							console.log("variables");
							console.log(val1);
						  //val1 = val1 + data1;
						  //$('#div1').html(data1);
					  }
					  else
					  {//data1 is the html for cart template
						val1 = "<br><center><h3>No Products Were Selected Yet!</center><br></h3>";
						document.getElementById('div1').innerHTML  = val1;
						console.log("test");
                     
					  }
                   
                    }
                });
}



/////////////




//https://stackoverflow.com/questions/51300809/load-html-first-before-javascript
//https://stackoverflow.com/questions/588040/window-onload-vs-document-onload
//https://www.skillsugar.com/how-to-use-document-onload-in-javascript


window.onload = function()
{	
	
	
}



/////////////
  

  </script>



</body>
</html>